# This resolver is necessary for Nginx inside Docker to resolve the service names.
# 127.0.0.11 is the internal Docker DNS server.
resolver 127.0.0.11 valid=30s;

server {
    listen 80;
    # Increase the client body size to allow for large file uploads (e.g., stimuli, media)
    client_max_body_size 100M;

    # --- Session Manager Service ---
    # Handles creation/management of experiments and sessions.
    # ### <<< 修正点 >>> ###
    # BIDS exportリクエストも session_manager が受けるようにするため、
    # この location ブロックの対象を広げます。
    location ~ ^/api/v1/(experiments|sessions|calibrations|stimuli) {
        set $session_manager_upstream http://session_manager:3000;
        proxy_pass $session_manager_upstream;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
    }


    # --- Auth Manager Service ---
    # Handles all authentication and authorization checks.
    location /api/v1/auth {
        set $auth_manager_upstream http://auth_manager:3000;
        proxy_pass $auth_manager_upstream;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
    }

    # --- Collector Service ---
    # Entrypoint for all incoming raw sensor and media data.
    location /api/v1/data {
        set $collector_upstream http://collector:3000;
        proxy_pass $collector_upstream;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_connect_timeout 60s;
        proxy_send_timeout 60s;
        proxy_read_timeout 60s;
    }
    location /api/v1/media {
        set $collector_media_upstream http://collector:3000;
        proxy_pass $collector_media_upstream;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_connect_timeout 60s;
        proxy_send_timeout 60s;
        proxy_read_timeout 60s;
    }

    # --- Realtime Analyzer Service ---
    # Provides real-time analysis results for a given user.
    location /api/v1/users/ {
        set $realtime_analyzer_upstream http://realtime_analyzer:5002;
        proxy_pass $realtime_analyzer_upstream;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-for $proxy_add_x_forwarded_for;
    }

    # --- BIDS Exporter Service ---
    # ### <<< 修正点 >>> ###
    # exportリクエストは session_manager がハンドルするため、このブロックは不要になります。
    # location ~ ^/api/v1/experiments/([a-fA-F0-9-]+)/export {
    #     proxy_pass http://bids_exporter:8000;
    #     proxy_set_header Host $host;
    #     proxy_set_header X-Real-IP $remote_addr;
    #     proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
    # }

    # Matches /api/v1/export-tasks/... to get status or download
    location /api/v1/export-tasks {
        set $bids_exporter_upstream http://bids_exporter:8000;
        proxy_pass $bids_exporter_upstream;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
    }

    location /api/v1/neuro-marketing {
        # 変数を設定して後続のproxy_passで利用
        set $erp_neuro_service http://erp_neuro_marketing:8001;
        proxy_pass $erp_neuro_service;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_connect_timeout 60s;
        proxy_send_timeout 300s;  # 解析に時間がかかる可能性を考慮
        proxy_read_timeout 300s;   # 解析に時間がかかる可能性を考慮
    }

    # --- Health Check ---
    # Provide both versioned and legacy health endpoints for compatibility.
    location = /health {
        set $collector_health_upstream http://collector:3000/api/v1/health;
        proxy_pass $collector_health_upstream;
        proxy_set_header Host $host;
    }

    location /api/v1/health {
        # Can proxy to any upstream service, collector is a good choice.
        set $collector_health_upstream http://collector:3000/api/v1/health;
        proxy_pass $collector_health_upstream;
        proxy_set_header Host $host;
    }
}
